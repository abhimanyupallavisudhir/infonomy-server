{% extends "base.html" %}

{% block title %}Profile Setup - Infonomy{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-setup">
        <h1 class="profile-title">Complete Your Profile</h1>
        <p class="profile-subtitle">You need both a buyer and seller profile to use Infonomy</p>
        
        <!-- Buyer Profile Section -->
        <div class="profile-section">
            <h2>Buyer Profile</h2>
            {% if user.buyer_profile %}
                <div class="current-profile">
                    <p><strong>✓ Buyer Profile Created</strong></p>
                    <p><strong>Default Child LLM:</strong> {{ user.buyer_profile.default_child_llm.name }}</p>
                </div>
            {% else %}
                <p>Create a buyer profile to ask questions and purchase information.</p>
                <form method="post" action="/profile/buyer" class="profile-form">
                    <div class="form-group">
                        <label for="default_child_llm">Default Child LLM:</label>
                        <select name="default_child_llm" id="default_child_llm" required>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="claude-3">Claude 3</option>
                            <option value="claude-2">Claude 2</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Create Buyer Profile</button>
                </form>
            {% endif %}
        </div>
        
        <!-- Seller Profile Section -->
        <div class="profile-section">
            <h2>Seller Profile</h2>
            {% if user.seller_profile %}
                <div class="current-profile">
                    <p><strong>✓ Seller Profile Created</strong></p>
                    <p><strong>Matchers:</strong> {{ user.seller_profile.matchers|length }}</p>
                </div>
            {% else %}
                <p>Create a seller profile to provide answers and earn money.</p>
                <form method="post" action="/profile/seller" class="profile-form">
                    <button type="submit" class="btn btn-primary">Create Seller Profile</button>
                </form>
            {% endif %}
        </div>
        
        <!-- Continue Button -->
        {% if user.buyer_profile and user.seller_profile %}
            <div class="continue-section">
                <p class="success-message">✓ Your profile is complete!</p>
                <a href="/" class="btn btn-success">Continue to Infonomy</a>
            </div>
        {% else %}
            <div class="continue-section">
                <p class="info-message">Complete both profiles to continue</p>
            </div>
        {% endif %}
        
        <!-- Profile Tabs (only show when both profiles exist) -->
        {% if user.buyer_profile and user.seller_profile %}
            <div class="profile-tabs">
                <button class="tab-btn active" onclick="showTab('matchers')">Matchers</button>
                <button class="tab-btn" onclick="showTab('bot-sellers')">Bot Sellers</button>
                <button class="tab-btn" onclick="showTab('inbox')">Inbox</button>
                <button class="tab-btn" onclick="showTab('purchased')">Purchased Info</button>
                <button class="tab-btn" onclick="showTab('my-content')">My Content</button>
            </div>
            
            <div class="tab-content">
                <!-- Matchers Tab -->
                <div id="matchers-tab" class="tab-pane active">
                    <h3>Matchers</h3>
                    <div class="matchers-list">
                        {% for matcher in profile_user.seller_profile.matchers %}
                            <div class="matcher-item">
                                <strong>Keywords:</strong> {{ matcher.keywords|join(', ') if matcher.keywords else 'None' }}<br>
                                <strong>Min Budget:</strong> ${{ "%.2f"|format(matcher.min_max_budget) }}<br>
                                <strong>Min Priority:</strong> {{ matcher.min_priority }}
                                <button onclick="deleteMatcher({{ matcher.id }})" class="btn btn-danger btn-sm">Delete</button>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <h4>Add New Matcher</h4>
                    <form method="post" action="/profile/matcher" class="profile-form">
                        <div class="form-group">
                            <label for="keywords">Keywords (comma-separated):</label>
                            <input type="text" name="keywords" id="keywords" placeholder="keyword1, keyword2">
                        </div>
                        
                        <div class="form-group">
                            <label for="context_pages">Context Pages (comma-separated):</label>
                            <input type="text" name="context_pages" id="context_pages" placeholder="page1, page2">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="min_max_budget">Min Max Budget:</label>
                                <input type="number" name="min_max_budget" id="min_max_budget" step="0.01" min="0" value="0.00">
                            </div>
                            
                            <div class="form-group">
                                <label for="min_priority">Min Priority:</label>
                                <select name="min_priority" id="min_priority">
                                    <option value="0">Low (0)</option>
                                    <option value="1">High (1)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Add Matcher</button>
                    </form>
                </div>
                
                <!-- Bot Sellers Tab -->
                <div id="bot-sellers-tab" class="tab-pane">
                    <h3>Bot Sellers</h3>
                    {% if profile_user.bot_sellers %}
                        <div class="bot-sellers-list">
                            {% for bot in profile_user.bot_sellers %}
                                <div class="bot-seller-item">
                                    <strong>Info:</strong> {{ bot.info or 'None' }}<br>
                                    <strong>Price:</strong> ${{ "%.2f"|format(bot.price) if bot.price else 'Free' }}<br>
                                    <strong>LLM Model:</strong> {{ bot.llm_model or 'Default' }}
                                    <button onclick="deleteBotSeller({{ bot.id }})" class="btn btn-danger btn-sm">Delete</button>
                                    
                                    <!-- Bot Matchers -->
                                    <div class="bot-matchers">
                                        <h5>Bot Matchers:</h5>
                                        {% if bot.matchers %}
                                            {% for matcher in bot.matchers %}
                                                <div class="matcher-item">
                                                    <strong>Keywords:</strong> {{ matcher.keywords|join(', ') if matcher.keywords else 'None' }}<br>
                                                    <strong>Min Budget:</strong> ${{ "%.2f"|format(matcher.min_max_budget) }}
                                                    <button onclick="deleteBotMatcher({{ matcher.id }})" class="btn btn-danger btn-sm">Delete</button>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <p>No matchers for this bot.</p>
                                        {% endif %}
                                        
                                        <h6>Add Bot Matcher:</h6>
                                        <form method="post" action="/profile/bot-matcher" class="profile-form">
                                            <input type="hidden" name="bot_seller_id" value="{{ bot.id }}">
                                            <div class="form-group">
                                                <label for="bot_keywords">Keywords (comma-separated):</label>
                                                <input type="text" name="keywords" id="bot_keywords" placeholder="keyword1, keyword2">
                                            </div>
                                            <div class="form-group">
                                                <label for="bot_min_budget">Min Budget:</label>
                                                <input type="number" name="min_max_budget" id="bot_min_budget" step="0.01" min="0" value="0.00">
                                            </div>
                                            <button type="submit" class="btn btn-primary">Add Bot Matcher</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No bot sellers yet.</p>
                    {% endif %}
                    
                    <h4>Create Bot Seller</h4>
                    <form method="post" action="/profile/bot-seller" class="profile-form">
                        <div class="form-group">
                            <label for="info">Info:</label>
                            <input type="text" name="info" id="info" placeholder="Bot description">
                        </div>
                        
                        <div class="form-group">
                            <label for="price">Price:</label>
                            <input type="number" name="price" id="price" step="0.01" min="0" value="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="llm_model">LLM Model:</label>
                            <input type="text" name="llm_model" id="llm_model" placeholder="Model name">
                        </div>
                        
                        <div class="form-group">
                            <label for="llm_prompt">LLM Prompt:</label>
                            <textarea name="llm_prompt" id="llm_prompt" placeholder="Custom prompt for the bot"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Create Bot Seller</button>
                    </form>
                </div>
                
                <!-- Inbox Tab -->
                <div id="inbox-tab" class="tab-pane">
                    <h3>Inbox</h3>
                    {% if profile_user.seller_profile and profile_user.seller_profile.matchers %}
                        {% set inbox_items = [] %}
                        {% for matcher in profile_user.seller_profile.matchers %}
                            {% for item in matcher.inbox_items %}
                                {% set _ = inbox_items.append(item) %}
                            {% endfor %}
                        {% endfor %}
                        
                        {% if inbox_items %}
                            <div class="inbox-items">
                                {% for item in inbox_items %}
                                    <div class="inbox-item">
                                        <strong>Context:</strong> {{ item.decision_context.query[:50] }}...<br>
                                        <strong>Status:</strong> 
                                        <select onchange="updateInboxStatus({{ item.id }}, this.value)">
                                            <option value="new" {% if item.status == 'new' %}selected{% endif %}>New</option>
                                            <option value="ignored" {% if item.status == 'ignored' %}selected{% endif %}>Ignored</option>
                                            <option value="responded" {% if item.status == 'responded' %}selected{% endif %}>Responded</option>
                                        </select>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p>No inbox items yet.</p>
                        {% endif %}
                    {% else %}
                        <p>Create matchers to receive inbox items.</p>
                    {% endif %}
                </div>
                
                <!-- Purchased Info Tab -->
                <div id="purchased-tab" class="tab-pane">
                    <h3>Purchased Info</h3>
                    <p>This section will show information you've purchased.</p>
                </div>
                
                <!-- My Content Tab -->
                <div id="my-content-tab" class="tab-pane">
                    <h3>My Questions</h3>
                    {% if questions %}
                        <div class="questions-list">
                            {% for question in questions %}
                                <div class="question-item">
                                    <a href="/questions/{{ question.id }}">{{ question.query[:100] }}...</a>
                                    <span class="question-meta">${{ "%.2f"|format(question.max_budget) }} | Priority: {{ question.priority }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No questions asked yet.</p>
                    {% endif %}
                    
                    <h3>My Answers</h3>
                    {% if answers %}
                        <div class="answers-list">
                            {% for answer in answers %}
                                <div class="answer-item">
                                    <a href="/questions/{{ answer.context_id }}">{{ answer.private_info[:100] }}...</a>
                                    <span class="answer-meta">${{ "%.2f"|format(answer.price) }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No answers provided yet.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.profile-setup {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.profile-title {
    text-align: center;
    color: #333;
    margin-bottom: 0.5rem;
}

.profile-subtitle {
    text-align: center;
    color: #666;
    margin-bottom: 2rem;
}

.profile-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #fafafa;
}

.profile-section h2 {
    color: #333;
    margin-bottom: 1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.current-profile {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 4px;
    padding: 1rem;
    color: #155724;
}

.profile-form {
    margin-top: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #333;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.continue-section {
    text-align: center;
    margin-top: 2rem;
    padding: 1.5rem;
    border-top: 1px solid #e0e0e0;
}

.success-message {
    color: #28a745;
    font-weight: bold;
    margin-bottom: 1rem;
}

    .info-message {
        color: #6c757d;
        font-style: italic;
    }
    
    /* Tab styles */
    .profile-tabs {
        margin-top: 2rem;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .tab-btn {
        background: none;
        border: none;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-right: 0.5rem;
    }
    
    .tab-btn.active {
        border-bottom-color: #007bff;
        color: #007bff;
    }
    
    .tab-content {
        margin-top: 1rem;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    .form-row {
        display: flex;
        gap: 1rem;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .matcher-item, .bot-seller-item, .question-item, .answer-item {
        border: 1px solid #e0e0e0;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .bot-matchers {
        margin-top: 1rem;
        padding: 1rem;
        background: #e9ecef;
        border-radius: 4px;
    }
    
    .inbox-items .inbox-item {
        border: 1px solid #e0e0e0;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .question-meta, .answer-meta {
        color: #6c757d;
        font-size: 0.875rem;
        margin-left: 1rem;
    }
</style>

<script>
function showTab(tabName) {
    // Hide all tab panes
    const tabPanes = document.querySelectorAll('.tab-pane');
    tabPanes.forEach(pane => pane.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab pane
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Placeholder functions for delete operations
function deleteMatcher(matcherId) {
    if (confirm('Are you sure you want to delete this matcher?')) {
        // TODO: Implement matcher deletion
        alert('Matcher deletion not yet implemented');
    }
}

function deleteBotSeller(botId) {
    if (confirm('Are you sure you want to delete this bot seller?')) {
        // TODO: Implement bot seller deletion
        alert('Bot seller deletion not yet implemented');
    }
}

function deleteBotMatcher(matcherId) {
    if (confirm('Are you sure you want to delete this bot matcher?')) {
        // TODO: Implement bot matcher deletion
        alert('Bot matcher deletion not yet implemented');
    }
}

function updateInboxStatus(inboxId, status) {
    // TODO: Implement inbox status update
    console.log('Updating inbox item', inboxId, 'to status:', status);
}
</script>
{% endblock %} 