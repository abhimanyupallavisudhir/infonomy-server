{% extends "base.html" %}

{% block title %}{{ profile_user.username }}'s Profile - Infonomy{% endblock %}

{% block content %}
<div class="container">
    <div class="user-profile">
        <div class="profile-header">
            <h1 class="profile-title">{{ profile_user.username }}'s Profile</h1>
            <div class="profile-meta">
                <span class="balance">Balance: ${{ "%.2f"|format(profile_user.balance) }}</span>
                <span class="member-since">Member since: {{ profile_user.created_at.strftime('%Y-%m-%d') }}</span>
            </div>
        </div>
        
        {% if is_own_profile %}
            <div class="profile-tabs">
                <button class="tab-btn active" onclick="showTab('profile')">Profile</button>
                <button class="tab-btn" onclick="showTab('matchers')">Matchers</button>
                <button class="tab-btn" onclick="showTab('bot-sellers')">Bot Sellers</button>
                <button class="tab-btn" onclick="showTab('inbox')">Inbox</button>
                <button class="tab-btn" onclick="showTab('my-content')">My Content</button>
            </div>
            
            <div class="tab-content">
                <!-- Profile Tab (Combined Buyer + Seller) -->
                <div id="profile-tab" class="tab-pane active">
                    <h3>Profile</h3>
                    
                    <!-- Buyer Profile Section -->
                    <div class="profile-section">
                        <h4>Buyer Profile</h4>
                        {% if profile_user.buyer_profile %}
                            <div class="current-profile">
                                <p><strong>✓ Buyer Profile Created</strong></p>
                                <p><strong>Default Child LLM:</strong> {{ profile_user.buyer_profile.default_child_llm.name }}</p>
                            </div>
                        {% else %}
                            <p>Create a buyer profile to ask questions and purchase information.</p>
                        {% endif %}
                        
                        <form method="post" action="/profile/buyer" class="profile-form">
                            <div class="form-group">
                                <label for="default_child_llm">Default Child LLM:</label>
                                <select name="default_child_llm" id="default_child_llm" required>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    <option value="claude-3">Claude 3</option>
                                    <option value="claude-2">Claude 2</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                {% if profile_user.buyer_profile %}Update{% else %}Create{% endif %} Buyer Profile
                            </button>
                        </form>
                    </div>
                    
                    <!-- Seller Profile Section -->
                    <div class="profile-section">
                        <h4>Seller Profile</h4>
                        {% if profile_user.seller_profile %}
                            <div class="current-profile">
                                <p><strong>✓ Seller Profile Created</strong></p>
                                <p><strong>Matchers:</strong> {{ profile_user.seller_profile.matchers|length }}</p>
                            </div>
                        {% else %}
                            <p>Create a seller profile to provide answers and earn money.</p>
                        {% endif %}
                        
                        <form method="post" action="/profile/seller" class="profile-form">
                            <button type="submit" class="btn btn-primary">
                                {% if profile_user.seller_profile %}Update{% else %}Create{% endif %} Seller Profile
                            </button>
                        </form>
                    </div>
                    
                    <!-- API Keys Section -->
                    <div class="profile-section">
                        <h4>API Keys</h4>
                        <p>Manage your API keys for LLM services.</p>
                        
                        <form method="post" action="/profile/api-keys" class="profile-form" id="api-keys-form">
                            <div class="api-keys-container" id="api-keys-container">
                                {% if profile_user.api_keys %}
                                    {% for key_name, key_value in profile_user.api_keys.items() %}
                                        <div class="api-key-row">
                                            <input type="text" name="key_names" value="{{ key_name }}" placeholder="Key name" class="api-key-name">
                                            <input type="text" name="key_values" value="{{ key_value }}" placeholder="Key value" class="api-key-value">
                                            <button type="button" onclick="removeApiKeyRow(this)" class="btn btn-danger btn-sm">×</button>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="api-key-row">
                                        <input type="text" name="key_names" placeholder="Key name" class="api-key-name">
                                        <input type="text" name="key_values" placeholder="Key value" class="api-key-value">
                                        <button type="button" onclick="removeApiKeyRow(this)" class="btn btn-danger btn-sm">×</button>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="api-keys-actions">
                                <button type="button" onclick="addApiKeyRow()" class="btn btn-secondary">Add New API Key</button>
                                <button type="submit" class="btn btn-primary">Save API Keys</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Matchers Tab -->
                <div id="matchers-tab" class="tab-pane">
                    <h3>Matchers</h3>
                    {% if profile_user.seller_profile %}
                        <div class="matchers-list">
                            {% for matcher in profile_user.seller_profile.matchers %}
                                <div class="matcher-item">
                                    <strong>Keywords:</strong> {{ matcher.keywords|join(', ') if matcher.keywords else 'None' }}<br>
                                    <strong>Min Budget:</strong> ${{ "%.2f"|format(matcher.min_max_budget) }}<br>
                                    <strong>Min Priority:</strong> {{ matcher.min_priority }}
                                    <button onclick="deleteMatcher({{ matcher.id }})" class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <h4>Add New Matcher</h4>
                        <form method="post" action="/profile/matcher" class="profile-form">
                            <div class="form-group">
                                <label for="keywords">Keywords (comma-separated):</label>
                                <input type="text" name="keywords" id="keywords" placeholder="keyword1, keyword2">
                            </div>
                            
                            <div class="form-group">
                                <label for="context_pages">Context Pages (comma-separated):</label>
                                <input type="text" name="context_pages" id="context_pages" placeholder="page1, page2">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="min_max_budget">Min Max Budget:</label>
                                    <input type="number" name="min_max_budget" id="min_max_budget" step="0.01" min="0" value="0.00">
                                </div>
                                
                                <div class="form-group">
                                    <label for="min_priority">Min Priority:</label>
                                    <select name="min_priority" id="min_priority">
                                        <option value="0">Low (0)</option>
                                        <option value="1">High (1)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Add Matcher</button>
                        </form>
                    {% else %}
                        <p>Create a seller profile first to add matchers.</p>
                        <form method="post" action="/profile/seller" class="profile-form">
                            <button type="submit" class="btn btn-primary">Create Seller Profile</button>
                        </form>
                    {% endif %}
                </div>
                
                <!-- Bot Sellers Tab -->
                <div id="bot-sellers-tab" class="tab-pane">
                    <h3>Bot Sellers</h3>
                    {% if profile_user.bot_sellers %}
                        <div class="bot-sellers-list">
                            {% for bot in profile_user.bot_sellers %}
                                <div class="bot-seller-item">
                                    <strong>Info:</strong> {{ bot.info or 'None' }}<br>
                                    <strong>Price:</strong> ${{ "%.2f"|format(bot.price) if bot.price else 'Free' }}<br>
                                    <strong>LLM Model:</strong> {{ bot.llm_model or 'Default' }}
                                    <button onclick="deleteBotSeller({{ bot.id }})" class="btn btn-danger btn-sm">Delete</button>
                                    
                                    <!-- Bot Matchers -->
                                    <div class="bot-matchers">
                                        <h5>Bot Matchers:</h5>
                                        {% if bot.matchers %}
                                            {% for matcher in bot.matchers %}
                                                <div class="matcher-item">
                                                    <strong>Keywords:</strong> {{ matcher.keywords|join(', ') if matcher.keywords else 'None' }}<br>
                                                    <strong>Min Budget:</strong> ${{ "%.2f"|format(matcher.min_max_budget) }}
                                                    <button onclick="deleteBotMatcher({{ matcher.id }})" class="btn btn-danger btn-sm">Delete</button>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <p>No matchers for this bot.</p>
                                        {% endif %}
                                        
                                        <h6>Add Bot Matcher:</h6>
                                        <form method="post" action="/profile/bot-matcher" class="profile-form">
                                            <input type="hidden" name="bot_seller_id" value="{{ bot.id }}">
                                            <div class="form-group">
                                                <label for="bot_keywords">Keywords (comma-separated):</label>
                                                <input type="text" name="keywords" id="bot_keywords" placeholder="keyword1, keyword2">
                                            </div>
                                            <div class="form-group">
                                                <label for="bot_min_budget">Min Budget:</label>
                                                <input type="number" name="min_max_budget" id="bot_min_budget" step="0.01" min="0" value="0.00">
                                            </div>
                                            <button type="submit" class="btn btn-primary">Add Bot Matcher</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No bot sellers yet.</p>
                    {% endif %}
                    
                    <h4>Create Bot Seller</h4>
                    <form method="post" action="/profile/bot-seller" class="profile-form">
                        <div class="form-group">
                            <label for="info">Info:</label>
                            <input type="text" name="info" id="info" placeholder="Bot description">
                        </div>
                        
                        <div class="form-group">
                            <label for="price">Price:</label>
                            <input type="number" name="price" id="price" step="0.01" min="0" value="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="llm_model">LLM Model:</label>
                            <input type="text" name="llm_model" id="llm_model" placeholder="Model name">
                        </div>
                        
                        <div class="form-group">
                            <label for="llm_prompt">LLM Prompt:</label>
                            <textarea name="llm_prompt" id="llm_prompt" placeholder="Custom prompt for the bot"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Create Bot Seller</button>
                    </form>
                </div>
                
                <!-- Inbox Tab -->
                <div id="inbox-tab" class="tab-pane">
                    <h3>Inbox</h3>
                    {% if profile_user.seller_profile and profile_user.seller_profile.matchers %}
                        {% set inbox_items = [] %}
                        {% for matcher in profile_user.seller_profile.matchers %}
                            {% for item in matcher.inbox_items %}
                                {% set _ = inbox_items.append(item) %}
                            {% endfor %}
                        {% endfor %}
                        
                        {% if inbox_items %}
                            <div class="inbox-items">
                                {% for item in inbox_items %}
                                    <div class="inbox-item">
                                        <strong>Context:</strong> {{ item.decision_context.query[:50] }}...<br>
                                        <strong>Status:</strong> 
                                        <select onchange="updateInboxStatus({{ item.id }}, this.value)">
                                            <option value="new" {% if item.status == 'new' %}selected{% endif %}>New</option>
                                            <option value="ignored" {% if item.status == 'ignored' %}selected{% endif %}>Ignored</option>
                                            <option value="responded" {% if item.status == 'responded' %}selected{% endif %}>Responded</option>
                                        </select>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p>No inbox items yet.</p>
                        {% endif %}
                    {% else %}
                        <p>Create matchers to receive inbox items.</p>
                    {% endif %}
                </div>
                
                <!-- My Content Tab -->
                <div id="my-content-tab" class="tab-pane">
                    <h3>My Questions</h3>
                    {% if questions %}
                        <div class="questions-list">
                            {% for question in questions %}
                                <div class="question-item">
                                    <a href="/questions/{{ question.id }}">{{ question.query[:100] }}...</a>
                                    <span class="question-meta">${{ "%.2f"|format(question.max_budget) }} | Priority: {{ question.priority }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No questions asked yet.</p>
                    {% endif %}
                    
                    <h3>My Answers</h3>
                    {% if answers %}
                        <div class="answers-list">
                            {% for answer in answers %}
                                <div class="answer-item">
                                    <a href="/questions/{{ answer.context_id }}">{{ answer.private_info[:100] }}...</a>
                                    <span class="answer-meta">${{ "%.2f"|format(answer.price) }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No answers provided yet.</p>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <!-- Public profile view -->
            <div class="public-profile">
                <div class="profile-section">
                    <h3>Questions Asked</h3>
                    {% if questions %}
                        <div class="questions-list">
                            {% for question in questions %}
                                <div class="question-item">
                                    <a href="/questions/{{ question.id }}">{{ question.query or "No title" }}</a>
                                    <span class="meta">${{ "%.2f"|format(question.max_budget) }} | Priority: {{ question.priority }} | {{ question.created_at.strftime('%Y-%m-%d') }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No questions asked yet.</p>
                    {% endif %}
                </div>
                
                <div class="profile-section">
                    <h3>Answers Provided</h3>
                    {% if answers %}
                        <div class="answers-list">
                            {% for answer in answers %}
                                <div class="answer-item">
                                    <a href="/questions/{{ answer.context_id }}">View Question</a>
                                    <span class="meta">${{ "%.2f"|format(answer.price) }} | {{ answer.created_at.strftime('%Y-%m-%d') }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No answers provided yet.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
    .user-profile {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .profile-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .profile-title {
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .profile-meta {
        color: #666;
        font-size: 0.9rem;
    }
    
    .profile-meta span {
        margin: 0 0.5rem;
    }
    
    /* Tab styles */
    .profile-tabs {
        margin: 2rem 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .tab-btn {
        background: none;
        border: none;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-right: 0.5rem;
    }
    
    .tab-btn.active {
        border-bottom-color: #007bff;
        color: #007bff;
    }
    
    .tab-content {
        margin-top: 1rem;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    .profile-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #fafafa;
    }
    
    .profile-section h4 {
        color: #333;
        margin-bottom: 1rem;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
    }
    
    .current-profile {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    
    .profile-form {
        margin-top: 1rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }
    
    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-row {
        display: flex;
        gap: 1rem;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .matcher-item, .bot-seller-item, .question-item, .answer-item {
        border: 1px solid #e0e0e0;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .bot-matchers {
        margin-top: 1rem;
        padding: 1rem;
        background: #e9ecef;
        border-radius: 4px;
    }
    
    .inbox-items .inbox-item {
        border: 1px solid #e0e0e0;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .question-meta, .answer-meta {
        color: #6c757d;
        font-size: 0.875rem;
        margin-left: 1rem;
    }
    
    .public-profile {
        margin-top: 2rem;
    }
    
    .meta {
        color: #6c757d;
        font-size: 0.875rem;
        margin-left: 1rem;
    }
    
    /* API Keys Styling */
    .api-keys-container {
        margin-bottom: 1rem;
    }
    
    .api-key-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
    }
    
    .api-key-name {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .api-key-value {
        flex: 2;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .api-keys-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .api-keys-actions .btn {
        padding: 0.5rem 1rem;
    }
</style>

<script>
function showTab(tabName) {
    // Hide all tab panes
    const tabPanes = document.querySelectorAll('.tab-pane');
    tabPanes.forEach(pane => pane.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab pane
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

function updateInboxStatus(inboxId, status) {
    fetch(`/api/inbox/${inboxId}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({ status: status })
    })
    .then(response => response.json())
    .then(result => {
        console.log('Inbox status updated:', result);
    })
    .catch(error => {
        console.error('Error updating inbox status:', error);
        alert('Failed to update inbox status');
    });
}

function deleteMatcher(matcherId) {
    if (confirm('Are you sure you want to delete this matcher?')) {
        // TODO: Implement matcher deletion
        alert('Matcher deletion not yet implemented');
    }
}

function deleteBotSeller(botId) {
    if (confirm('Are you sure you want to delete this bot seller?')) {
        // TODO: Implement bot seller deletion
        alert('Bot seller deletion not yet implemented');
    }
}

function deleteBotMatcher(matcherId) {
    if (confirm('Are you sure you want to delete this bot matcher?')) {
        // TODO: Implement bot matcher deletion
        alert('Bot matcher deletion not yet implemented');
    }
}

function addApiKeyRow() {
    const container = document.getElementById('api-keys-container');
    const newRow = document.createElement('div');
    newRow.className = 'api-key-row';
    newRow.innerHTML = `
        <input type="text" name="key_names" placeholder="Key name" class="api-key-name">
        <input type="text" name="key_values" placeholder="Key value" class="api-key-value">
        <button type="button" onclick="removeApiKeyRow(this)" class="btn btn-danger btn-sm">×</button>
    `;
    container.appendChild(newRow);
}

function removeApiKeyRow(button) {
    const row = button.parentElement;
    const container = document.getElementById('api-keys-container');
    
    // Don't remove the last row if it's the only one
    if (container.children.length > 1) {
        row.remove();
    } else {
        // Clear the inputs instead of removing the row
        const inputs = row.querySelectorAll('input');
        inputs.forEach(input => input.value = '');
    }
}
</script>
{% endblock %}

 