{% extends "base.html" %}

{% block title %}{{ question.query or "Question" }} - Infonomy{% endblock %}

{% block content %}
<div class="container">
    <div class="question-detail">
        <div class="question-header">
            <h1 class="question-title">{{ question.query or "No title" }}</h1>
            <div class="question-meta">
                <span class="budget">Budget: ${{ "%.2f"|format(question.max_budget) }}</span>
                <span class="priority">Priority: {{ question.priority }}</span>
                <span class="date">{{ question.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                <span class="author">by <a href="/users/{{ buyer.id }}">{{ buyer.username }}</a></span>
            </div>
            {% if question.context_pages %}
                <div class="context-pages">
                    <strong>Context:</strong> {{ question.context_pages|join(', ') }}
                </div>
            {% endif %}
            {% if is_question_owner %}
                <div class="inspection-section">
                    <button class="btn btn-primary inspect-btn" onclick="startInspection({{ question.id }})" id="inspect-btn">
                        Start Inspection
                    </button>
                    <div class="inspection-status hidden" id="inspection-status">
                        <div class="status-message">Inspection in progress...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        
        {% if user and user.seller_profile %}
            <div class="new-answer-form">
                <h3>Provide an Answer</h3>
                <form method="post" action="/questions/{{ question.id }}/answers">
                    <div class="form-group">
                        <label for="private_info">Private Information:</label>
                        <textarea name="private_info" id="private_info" rows="4" placeholder="The detailed information you're offering..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="public_info">Public Information (optional):</label>
                        <textarea name="public_info" id="public_info" rows="2" placeholder="A brief preview of your information..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="price">Price:</label>
                        <input type="number" name="price" id="price" step="0.01" min="0" value="0.00" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Submit Answer</button>
                </form>
            </div>
        {% elif not user %}
            <div class="login-prompt">
                <p><a href="/login">Login</a> to provide answers to this question.</p>
            </div>
        {% endif %}
        
        <div class="answers-section">
            <h3>Answers ({{ info_offers_data|length }})</h3>
            
            {% if info_offers_data %}
                <div class="answers-list">
                    {% for item in info_offers_data %}
                        {% set answer = item.info_offer %}
                        {% set human_seller = item.human_seller %}
                        {% set bot_seller = item.bot_seller %}
                        {% set bot_seller_owner = item.bot_seller_owner %}
                        
                        <div class="answer-card" data-answer-id="{{ answer.id }}">
                            <div class="answer-header">
                                <span class="seller-info">
                                    {% if human_seller %}
                                        <a href="/users/{{ human_seller.id }}" class="seller-link">{{ human_seller.username }}</a>
                                    {% elif bot_seller and bot_seller_owner %}
                                        Bot seller {{ bot_seller.id }} of <a href="/users/{{ bot_seller_owner.id }}" class="seller-link">{{ bot_seller_owner.username }}</a>
                                    {% else %}
                                        Unknown Seller
                                    {% endif %}
                                </span>
                                <span class="price">${{ "%.2f"|format(answer.price) }}</span>
                                <span class="date">{{ answer.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                            
                            {% if answer.public_info %}
                                <div class="public-info">
                                    {{ answer.public_info }}
                                </div>
                            {% endif %}
                            
                            <div class="private-info-section">
                                {% if is_question_owner and answer.purchased %}
                                    <div class="private-info">
                                        <strong>Private Information:</strong>
                                        <div class="private-content">{{ answer.private_info }}</div>
                                    </div>
                                {% else %}
                                    <div class="private-info-placeholder">
                                        <em>Private information - only visible to question owner after inspection</em>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No answers yet. Be the first to provide information!</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let inspectionJobId = null;
let statusCheckInterval = null;

function startInspection(questionId) {
    const inspectBtn = document.getElementById('inspect-btn');
    const statusDiv = document.getElementById('inspection-status');
    
    // Disable button and show status
    inspectBtn.disabled = true;
    inspectBtn.textContent = 'Starting Inspection...';
    statusDiv.classList.remove('hidden');
    
    // Start the inspection
    fetch(`/api/questions/${questionId}/inspect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.job_id) {
            inspectionJobId = data.job_id;
            checkInspectionStatus();
        } else {
            throw new Error('No job ID returned');
        }
    })
    .catch(error => {
        console.error('Error starting inspection:', error);
        alert('Failed to start inspection. Please try again.');
        resetInspectionUI();
    });
}

function checkInspectionStatus() {
    if (!inspectionJobId) return;
    
    fetch(`/api/jobs/${inspectionJobId}/status`)
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('inspection-status');
        const statusMessage = statusDiv.querySelector('.status-message');
        const progressFill = document.getElementById('progress-fill');
        
        switch (data.state) {
            case 'PENDING':
                statusMessage.textContent = 'Inspection queued...';
                progressFill.style.width = '10%';
                break;
            case 'STARTED':
                statusMessage.textContent = 'Inspection in progress...';
                progressFill.style.width = '50%';
                break;
            case 'SUCCESS':
                statusMessage.textContent = 'Inspection completed!';
                progressFill.style.width = '100%';
                setTimeout(() => {
                    window.location.reload(); // Reload to show purchased answers
                }, 2000);
                return; // Stop checking
            case 'FAILURE':
                statusMessage.textContent = 'Inspection failed: ' + (data.traceback || 'Unknown error');
                progressFill.style.width = '0%';
                resetInspectionUI();
                return; // Stop checking
            default:
                statusMessage.textContent = `Inspection status: ${data.state}`;
                progressFill.style.width = '25%';
        }
        
        // Continue checking if not finished
        if (data.state !== 'SUCCESS' && data.state !== 'FAILURE') {
            statusCheckInterval = setTimeout(checkInspectionStatus, 2000);
        }
    })
    .catch(error => {
        console.error('Error checking inspection status:', error);
        statusMessage.textContent = 'Error checking status';
        resetInspectionUI();
    });
}

function resetInspectionUI() {
    const inspectBtn = document.getElementById('inspect-btn');
    const statusDiv = document.getElementById('inspection-status');
    
    inspectBtn.disabled = false;
    inspectBtn.textContent = 'Start Inspection';
    statusDiv.classList.add('hidden');
    
    if (statusCheckInterval) {
        clearTimeout(statusCheckInterval);
        statusCheckInterval = null;
    }
}
</script>

<style>
    .inspection-section {
        margin: 1rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
    }
    
    .inspect-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
    }
    
    .inspect-btn:hover:not(:disabled) {
        background: #218838;
    }
    
    .inspect-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .inspection-status {
        margin-top: 1rem;
    }
    
    .status-message {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: #007bff;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .hidden {
        display: none;
    }
    
    .seller-link {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
    }
    
    .seller-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }
    
    .seller-info {
        font-weight: 500;
        color: #495057;
    }
</style>
{% endblock %} 